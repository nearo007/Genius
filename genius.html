<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearo Genius</title>
    <link rel="shortcut icon" href="./static/favicon/favicon.ico" type="image/x-icon">
    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: black;

            width: 100%;
            height: 100%;
        }

        h1 {
            color: white;
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
        }

        .div-score {
            color: white;
            position: fixed;
            top: 10px;
            right: 30px;
            padding: 10px;
            font-size: 25px;
            display: flex;
            flex-direction: column;
            align-items: start;
            justify-content: center;
            border: 3px solid white;
            border-radius: 5px;
        }

        .div-score p {
            margin: 10px 10px;
        }

        .button-play {
            display: flex;
            padding: 10px 10px 10px 15px;
            border-radius: 50%;
            background-color: white;

            margin-bottom: 30px;
            transition: background-color .1s;
        }

        .button-play:hover {
            background-color: rgb(192, 192, 192);
        }

        .button-play:active {
            background-color: white;
        }

        .button-play img {
            width: 40px;
            height: 40px;
            user-select: none;
        }

        .div-main-grid {
            display: grid;
            width: 450px;
            height: 450px;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 30px;
        }

        .div-main-grid div {
            border: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;

            background-color: transparent;
            font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;
            font-size: 30px;
            color: rgb(255, 255, 255);
            transition: background-color .1s;
            user-select: none;
        }

        .div-main-grid div:nth-child(1) {
            border-radius: 50% 0 20% 0;
            box-shadow: 0 0 45px rgb(0, 255, 200);
        }

        .div-main-grid div:nth-child(2) {
            border-radius: 0 50% 0 20%;
            box-shadow: 0 0 45px rgb(255, 0, 85);
        }

        .div-main-grid div:nth-child(3) {
            border-radius: 0 20% 0 50%;
            box-shadow: 0 0 45px rgb(208, 255, 0);
        }

        .div-main-grid div:nth-child(4) {
            border-radius: 20% 0 50% 0;
            box-shadow: 0 0 45px rgb(123, 255, 0);
        }
    </style>
</head>

<body>
    <div score class="div-score">
        <p>Score: 0</p>

        <p>Best: 0</p>
    </div>
    <h1>Nearo Genius</h1>
    <button class="button-play" onclick="startNewGame()">
        <img src="./static/img/icons/play-button-arrowhead.png" alt="Play">
    </button>

    <div class="div-main-grid">
        <div id="blue" colorButton onclick="flashButton('blue')"></div>
        <div id="red" colorButton onclick="flashButton('red')"></div>
        <div id="yellow" colorButton onclick="flashButton('yellow')"></div>
        <div id="green" colorButton onclick="flashButton('green')"></div>
    </div>
</body>

<script>
    let sequenceAmount = 1;

    const colorsRGB = {
        default: 'transparent',
        blue: 'rgb(0, 255, 200)',
        red: 'rgb(255, 0, 85)',
        yellow: 'rgb(208, 255, 0)',
        green: 'rgb(123, 255, 0)',
    }

    const audioPaths = {
        blue: './static/audio/C.mp3',
        red: './static/audio/F.mp3',
        yellow: './static/audio/G.mp3',
        green: './static/audio/Asharp.mp3',
        miss: './static/audio/C-Fsharp.mp3',
    }

    const colorsArray = ['blue', 'red', 'yellow', 'green'];

    let userSequenceArr = [];

    let bestScore = JSON.parse(localStorage.getItem('bestScore')) || 0;
    updateScore(0);


    function playAudio(audioParam, volume = 0.1) {
        audioParam.volume = volume;
        audioParam.play();
    }

    function flashButton(color) {
        const selectedId = '#' + color;
        const selectedButton = document.querySelector(selectedId);

        if (selectedButton) {
            selectedButton.style.backgroundColor = colorsRGB[color];
            audio = new Audio(audioPaths[color]);
            playAudio(audio, 0.5);

            setTimeout(() => {
                selectedButton.style.backgroundColor = colorsRGB['default'];
            }, 500);
        }
    }
    function getRandomFromArray(arrayParam) {
        const randomId = Math.floor(Math.random() * arrayParam.length);
        return arrayParam[randomId];
    }

    function getRandomColorSequence(totalColorsAmount, randomColorSequence) {
        const missingColorsAmount = totalColorsAmount - randomColorSequence.length;

        for (let i = 0; i < missingColorsAmount; i++) {
            const color = getRandomFromArray(colorsArray);
            randomColorSequence.push(color);
        }

        return randomColorSequence;
    }

    function triggerButton(buttonColor) {
        const buttonId = '#' + buttonColor;
        const buttonElement = document.querySelector(buttonId);

        flashButton(buttonColor);
    }

    function playSequence(randomColorSequence, startId = 0) {
        const playButton = document.querySelector('.button-play');
        playButton.style.pointerEvents = 'none';

        return new Promise((resolve) => {
            setTimeout(() => {
                if (!randomColorSequence[startId + 1]) {
                    triggerButton(randomColorSequence[startId])
                    playButton.style.pointerEvents = 'auto';
                    return resolve();
                }

                triggerButton(randomColorSequence[startId]);
                resolve(playSequence(randomColorSequence, startId + 1));
            }, 1000);
        })
    }

    // TODO ARRUMAR
    function toggleButtonClickable(buttonId) {
        const buttonFullId = '#' + buttonId;
        buttonElement = document.querySelector(buttonFullId);

        if (buttonElement) {
            if (buttonElement.style.pointerEvents == 'auto') {
                buttonElement.style.pointerEvents == 'none';
            }

            else if (buttonElement.style.pointerEvents == 'none') {
                buttonElement.style.pointerEvents == 'auto';
            }
        }
    }

    function arrayEquals(arr1, arr2) {
        return arr1.every((value, index) => value === arr2[index]);
    }

    function updateScore(score) {
        const scoreElement = document.querySelector('[score]').firstElementChild;
        scoreElement.innerHTML = `Score: ${score}`;

        const bestScoreElement = document.querySelector('[score]').lastElementChild;
        if (score > bestScore) {
            bestScore = score;
            bestScoreElement.innerHTML = `Best: ${bestScore}`;

            localStorage.setItem('bestScore', JSON.stringify(bestScore));
            return;
        }
        bestScoreElement.innerHTML = `Best: ${bestScore}`;
    }

    function addButtonClickLogic(randomColorSequence, resolveRound) {
        const buttons = document.querySelectorAll('[colorButton]');
        let currentIndex = 0;

        buttons.forEach(buttonElement => {
            buttonElement.onclick = () => {
                const clickedColor = buttonElement.id;
                userSequenceArr.push(clickedColor);

                // anima + som
                flashButton(clickedColor);

                // valida a posição atual
                if (clickedColor !== randomColorSequence[currentIndex]) {
                    resolveRound(false); // errou
                    return;
                }

                currentIndex++;

                // acertou toda a sequência
                if (currentIndex === randomColorSequence.length) {
                    updateScore(currentIndex);
                    resolveRound(true); // acertou
                }
            };
        });
    }


    function clearArray(arr) {
        arr.length = 0;
    }

    function getUserSequence(userSequenceArr) {
        return new Promise(resolve => {
            return resolve(userSequenceArr);
        })
    }

    function checkUserAttempt(userSequence, randomColorSequence) {
        return arrayEquals(userSequence, randomColorSequence);
    }

    async function startNewGame() {
        sequenceAmount = 1;
        let randomColorSequence = [];
        updateScore(0);

        while (true) {

            randomColorSequence = getRandomColorSequence(sequenceAmount, randomColorSequence);

            await playSequence(randomColorSequence);

            const userWon = await new Promise(resolve => {
                clearArray(userSequenceArr);
                addButtonClickLogic(randomColorSequence, resolve);
            });

            if (!userWon) {
                const audio = new Audio(audioPaths['miss']);
                flashButton('blue');
                flashButton('red');
                flashButton('yellow');
                flashButton('green');
                playAudio(audio, 0.5);

                updateScore(0);
                break;
            }

            sequenceAmount++;
        }
    }
</script>

</html>